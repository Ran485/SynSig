---
title: "Generate cross-matched SignatureAnalyzer and SigProfiler synthetic data to explore extraction of co-occuring high-burden and low-burden signatures"
author: "Steve Rozen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate cross-matched SignatureAnalyzer and SigProfiler synthetic data to explore extraction of co-occuring high-burden and low-burden signatures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview and rationale

Checking for interference between low-burden and high-burden signatures,
using MSI-high tumours as the source of high-burden signatures.

## Required libraries

```{r readSPprofiles}
library(ICAMS)
library(SynSig)
```

## Get actual exposures for high-mutational burden signatures, SBS26 and SBS44


```{r}

maybe.msi.samples <-
  setdiff(colnames(sa.all.real.exposures),
          colnames(sa.no.hyper.real.exposures))

maybe.msi.colorectal <-
  grep("ColoRect-AdenoCA::",maybe.msi.samples,
       fixed = TRUE, value = TRUE)

maybe.msi.uterus <-
  grep("Uterus-AdenoCA::",maybe.msi.samples,
       fixed = TRUE, value = TRUE)

maybe.msi <- sp.all.real.exposures[ , c(maybe.msi.colorectal, maybe.msi.uterus)]
maybe.msi2 <- maybe.msi[    , maybe.msi["SBS10a", ] < 10]

 # SBS14 is Combined POLE and MSI, so we do not use it.
sp.msi.exp <- maybe.msi2[    , maybe.msi2["SBS14", ] < 10]
# Look for SBS44, SBS26; SBS6 is rare

sa.msi.exp <- sa.all.real.exposures[ , colnames(sp.msi.exp)]

sp.msi.exp <- sp.msi.exp[c("SBS26", "SBS44"), ]
sa.msi.exp <- sa.msi.exp[c("BI_COMPOSITE_SBS26_S", "BI_COMPOSITE_SBS44_S"), ]

```

## Compute parameters and create synthetic expsoures for high-burden signtures

\code{SAAndSPSynDataOneCAType} will always include at least 1 non-zero exposure
in the the synthetic exposure output.

```{r}

SetNewOutDir("../../syn.MSI.high.low.for.SA/",
             overwrite = TRUE # For testing and development
             )

set.seed(191908)
num.syn.tumors <- 500

MSI.info <- 
  SAAndSPSynDataOneCAType(
    sa.msi.exp,
    sp.msi.exp,
    ca.type = NULL, # Do not filter by cancer type
    num.syn.tumors,
    file.prefix = "MSI")
```

## Triple the exposures of the MSI high tumors.

```{r TripleExp}
MSI.info$sa.syn.exp <- MSI.info$sa.syn.exp * 3
MSI.info$sp.syn.exp <- MSI.info$sp.syn.exp * 3

```



## Get actual exposures for low-mutational burden signatures, SBS1 and SBS2

```{r}

no.msi.colorectal <-
  grep("ColoRect-AdenoCA::", colnames(sa.no.hyper.real.exposures),
       fixed = TRUE, value = TRUE)

sp.no.msi.colorectal <- sp.all.real.exposures[ , no.msi.colorectal]
mean(sp.no.msi.colorectal["SBS1", ])
mean(sp.no.msi.colorectal["SBS5", ])

no.msi.uterus <-
  grep("Uterus-AdenoCA::", colnames(sa.no.hyper.real.exposures),
       fixed = TRUE, value = TRUE)
sp.no.msi.uterus <- sp.all.real.exposures[ , no.msi.uterus]
mean(sp.no.msi.uterus["SBS1", ])
mean(sp.no.msi.uterus["SBS5", ])

no.msi.colnames <- c(no.msi.colorectal, no.msi.uterus)

sp.no.msi.exp <-
  sp.all.real.exposures[c("SBS1", "SBS5"), no.msi.colnames]
stopifnot(dim(sp.no.msi.exp) == c(2, 81)) # sanity check

sa.no.msi.exp <-
  sa.all.real.exposures[
    c("BI_COMPOSITE_SBS1_P", "BI_COMPOSITE_SBS5_P"),
    no.msi.colnames]

```

There is no BI_COMPOSITE_SBS5_P in the SignatureAnalyzer exposures,
so we take the exposures from SBS5

```{r Replace5}

sa.no.msi.exp["BI_COMPOSITE_SBS5_P", ] <- sp.no.msi.exp["SBS5", ]

```

```{r MapSPToSA echo = FALSE}
# Alternative approach, not used
if (FALSE) {
  sa.no.msi.exp2 <- sa.no.msi.exp[rowSums(sa.no.msi.exp) > 0, ]
  sp.sa.map.info <-
    MapSPToSASignatureNamesInExposure(
      sp.exposures = sp.no.msi.exp,
      sa.sig.names.to.consider = rownames(sa.no.msi.exp2))
  
  knitr::kable(
    sp.sa.map.info$sp.to.sa.sig.match, 
    caption =
      'Best matches from SP signatures to SA signatures with exposures in MSI tumors',
    digits = 4)
  sa.no.msi.exp3 <- sa.no.msi.exp2[sp.sa.map.info$sp.to.sa.sig.match$to, ]
}
```


```{r SetSANoMSIExposures}
# View(sa.all.real.exposures[ , no.msi.colnames])
stopifnot(dim(sa.no.msi.exp) == c(2, 81)) # sanity check

```

## Compute parameters and create synthetic expsoures for low-burden signtures

```{r}

num.syn.tumors <- 500

no.MSI.info <- 
  SAAndSPSynDataOneCAType(
    sa.no.msi.exp,
    sp.no.msi.exp,
    ca.type = NULL, # Do not filter by cancer type
    num.syn.tumors,
    file.prefix = "NO.MSI")
```

## Exposures for a set of ~500 tumours with SBS1, SBS5, SBS26, and SBS44

Most tumors have a mix of all 4 signatures. This reflects
the SignatureAnalyzer strategy of dealing with the
"hypermutated" tumours separately.

Combine the high and low burden synthetic exposures.

```{r} 
sa.hyper.exp <-
  rbind(MSI.info$sa.syn.exp,
        no.MSI.info$sa.syn.exp)

sp.hyper.exp <-
  rbind(MSI.info$sp.syn.exp,
        no.MSI.info$sp.syn.exp)

```

## Remove hyper-mutated exposures that contain neither SBS26 nor SBS44

```{r RemoveNoHyper}

sa.to.keep <-
  (sa.hyper.exp["BI_COMPOSITE_SBS26_S", ] >= 1) |
  (sa.hyper.exp["BI_COMPOSITE_SBS44_S", ] >= 1)

sa.hyper.exp <- sa.hyper.exp[ , sa.to.keep]

sp.to.keep <-
  (sp.hyper.exp["SBS26", ] >= 1 ) |
  (sp.hyper.exp["SBS44", ] >= 1)

sp.hyper.exp <- sp.hyper.exp[ , sp.to.keep]


```

## Data set for SA -- one (SBS1, 5) catalog, one (SBS1, 5, 26, 44) catalog

### Catalogs for 500 tumors with only SBS1, 5

#### Create catalogs based on SignatureAnalyzer attributions

```{r}
sa.sa.COMPOSITE.no.hyper <-
  CreateAndWriteCatalog(
    sa.COMPOSITE.sigs,
    no.MSI.info$sa.syn.exp,
    "sa.sa.COMPOSITE",
    WriteCatCOMPOSITE,
    extra.file.suffix = "no.hyper")

sa.sa.96.no.hyper <-
  CreateAndWriteCatalog(
    sa.96.sigs,
    no.MSI.info$sa.syn.exp,
    "sa.sa.96",
    WriteCat96,
    extra.file.suffix = "no.hyper")
```

#### Create synthetic catalogs based on SigProfiler attributions

```{r}
sp.no.hyper.exp.renamed <- no.MSI.info$sp.syn.exp
rownames(sp.no.hyper.exp.renamed) <- rownames(no.MSI.info$sa.syn.exp) 
sp.sa.COMPOSITE.no.msi <- 
  CreateAndWriteCatalog(
    sa.COMPOSITE.sigs,
    sp.no.hyper.renamed,
    "sp.sa.COMPOSITE",
    WriteCatCOMPOSITE,
    extra.file.suffix = "no.hyper")
```


```{r}
sp.sp.no.hyper <-
CreateAndWriteCatalog(
  sp.sigs,
  no.MSI.info$sp.syn.exp,
  "sp.sp",
  WriteCat96,
  extra.file.suffix = "no.hyper")
```


### Catalogs for 500 tumors with SBS1, 5, 26, 4 TO DO

#### Create catalogs based on SignatureAnalyzer attributions

```{r}
sa.sa.COMPOSITE.hyper <-
  CreateAndWriteCatalog(
    sa.COMPOSITE.sigs,
    sa.hyper.exp,
    "sa.sa.COMPOSITE",
    WriteCatCOMPOSITE,
    extra.file.suffix = "hyper")

sa.sa.96.hyper <-
  CreateAndWriteCatalog(
    sa.96.sigs,
    sa.hyper.exp,
    "sa.sa.96",
    WriteCat96,
    extra.file.suffix = "hyper")

```

#### Create synthetic catalogs based on SigProfiler attributions

```{r}
sp.hyper.exp.renamed <- sp.hyper.exp
rownames(sp.hyper.exp.renamed) <- rownames(sp.hyper.exp) 
sp.sa.COMPOSITE.hyper <- 
  CreateAndWriteCatalog(
    sa.COMPOSITE.sigs,
    sp.hyper.renamed,
    "sp.sa.COMPOSITE",
    WriteCatCOMPOSITE,
    extra.file.suffix = "hyper")
```


```{r}
sp.sp.hyper<- 
CreateAndWriteCatalog(
  sp.sigs,
  sp.hyper,
  "sp.sp",
  WriteCat96,
  extra.file.suffix = "hyper")
```


## TO DO Run SignatureAnalyzer first on the 500 tumors with neither SBS26 nor SBS44, and then on the "hyper-mutated tumors"

## TO DO Run SigProfiler on the rbind of the first and second catalogs.

### Write the catalogs for SP





