---
title: "Generate cross-matched SignatureAnalyzer and SigProfiler synthetic data"
author: "Steve Rozen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate cross-matched SignatureAnalyzer and SigProfiler synthetic data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Conceptual challenges arise when comparing extraction of signatures between
different categorizations of mutation types.  

For example, in PCAWG7, SigProfiler reference signatures are based on
extraction of 96-channel signatures (i.e. single base substitutions -- SBS or SNS),
while SignatureAnalyzer reference signatures  are based on extraction of
"COMPOSITE" signatures consisting of SBS in pentanucleotide context plus
double base substitutions (DBSs) and indels (IDs).

A second challenge in generating "realistic" synthetic data is deciding
how many signatures operate in a given tumor time. Here we address
this challenge by generating different synthetic data sets, one
based on the larger number of signatures as extracted by
SignatureAnalyzer, and one based on the smaller number of signatures
extracted by SigProfiler.

In the end we take the cross product of the two choices, that is,
\verbatim{
 {96-channel, COMPOSITE} X {SignatureAnalyzer-attributions, SigProfiler-attributions}
}

## Required libraries, data, functions

```{r readSPprofiles}
library(ICAMS)
library(SynSig)
```

### Read SignatureAnalyzer exposures.

```{r signatureanalyzerexposure}

# TODO(Steve): wrap this in a function
sa.no.hyper.real.exposures <- 
  read.table(
    "SignatureAnalyzer_COMPOSITE_SNV.activity.no_POLE_MSI_SKIN_TMZ.031918.txt",
             sep = "\t", row.names = 1, header = TRUE)
colnames(sa.no.hyper.real.exposures) <-
  sub("__", "::", colnames(sa.no.hyper.real.exposures), fixed = TRUE)
colnames(sa.no.hyper.real.exposures) <-
  sub("_", "-", colnames(sa.no.hyper.real.exposures), fixed = TRUE)
rownames(sa.no.hyper.real.exposures) <-
  FixSASigNames(rownames(sa.no.hyper.real.exposures))
```

### Read SigProfiler exposures

Restrict it to "non hyper mutated" as
defined by the SignatureAnalyzer exposures.

```{r sigprofilerinputs}
# TODO(Steve): wrap this in a function
sp.real.exposures <-
  read.csv("PCAWG_sigProfiler_SBS_signatures_in_samples.csv",
                  as.is = TRUE, header = TRUE)
rownames(sp.real.exposures) <-
  paste0(sp.real.exposures$Cancer.Types, "::", sp.real.exposures$Sample.Names)
sp.real.exposures <- t(sp.real.exposures[ , -(1:3)])
sp.no.hyper.real.exposures <- 
  sp.real.exposures[ , colnames(sa.no.hyper.real.exposures)]
```

### Function to generate parallel synthetic data from SA and SP attributions and signature profiles

This function computes the SynSig parameters (proportion of tumors with
a given signature, mean of log of number of mutations, and standard
deviation of log of number of mutations) and the synthetic exposures
(but \strong{not} the catalogs).  This function also writes
these to files.

```{r}
SAAndSPSynDataOneCAType <-
  function(sa.real.exp, 
           sp.real.exp,
           ca.type, # Used in sample identifiers
           num.syn.tumors,
           file.prefix) {
    ca.type <- paste0(ca.type, "::")
    samples.to.use <- 
      grep(ca.type, colnames(sa.real.exp), fixed = TRUE)
    sa.exp <- sa.real.exp[ , samples.to.use]
    sp.exp <- sp.real.exp[ , samples.to.use]
    stopifnot(colnames(sa.exp) == colnames(sp.exp))
    sa.info <-
      GenerateSynFromReal(
        sa.exp, num.syn.tumors, 
        file.prefix = paste0("sa.", file.prefix),
        sample.id.prefix = paste0("SA.Syn.", ca.type, "S"))
    sp.info <-
      GenerateSynFromReal(
        sp.exp, num.syn.tumors,
        file.prefix = paste0("sp.", file.prefix),
        sample.id.prefix = paste0("SP.Syn.", ca.type, "S"))
    return(list(
      sa.parms  = sa.info$parms,
      sa.syn.exp = sa.info$syn.exp,
      sp.parms   = sp.info$parms,
      sp.syn.exp = sp.info$syn.exp))
}
```


## Example 1, Kidney-RCC and ovarian adenocarcinoma to explore SBS3, SBS5, and SBS40


It is probably easier to manage if the output, which is
is not in
a git-managed directory.
```{r}
SetNewOutDir("../../syn.3.5.40.rcc.and.ovary.v5/")
```

```{r}
set.seed(191905)
num.syn.tumors <- 500

rcc.info <- 
  SAAndSPSynDataOneCAType(
    sa.no.hyper.real.exposures,
    sp.no.hyper.real.exposures,
    ca.type = "Kidney-RCC",
    num.syn.tumors,
    file.prefix = "RCC")
```

```{r}

ovary.info <- 
  SAAndSPSynDataOneCAType(
    sa.no.hyper.real.exposures,
    sp.no.hyper.real.exposures,
    ca.type = "Ovary-AdenoCA",
    num.syn.tumors,
    file.prefix = "OVA")

```

Combine the RCC and ovarian adenocarcinoma synthetic exposures

```{r} 
# debug(MergeExposures)
sa.rcc.ova.syn.exp <-
  MergeExposures(list(rcc.info$sa.syn.exp, ovary.info$sa.syn.exp))

sp.rcc.ova.syn.exp <-
  MergeExposures(list(rcc.info$sp.syn.exp, ovary.info$sp.syn.exp))

# We will need the exposures later when evaluating the attributed signatures
WriteExposure(sa.rcc.ova.syn.exp, OutDir("sa.exposure.csv"))
WriteExposure(sp.rcc.ova.syn.exp, OutDir("sp.exposure.csv"))

```

### Generate synthetic catalogs for kidney-RCC plus ovary adenocarcinoma

#### Read SignatureAnalyzer mutational signature profiles and create synthetic catalogs

```{r signatureanalzyersigs}
                           
# COMPOSITE signature profiles
sa.COMPOSITE.sigs <- ReadSASigCOMPOSITE()

# 96-channel signature profiles
sa.96.sigs <- 
  ReadSASig96("SignatureAnalyzer_COMPOSITE_SBS_W96.signature.031918.txt")
colnames(sa.96.sigs) <- FixSASigNames(colnames(sa.96.sigs))
```

```{r}
# TODO(Steve): wrap the next lines into a function
sa.sa.COMPOSITE <- 
  GenSynCatalogs(sa.COMPOSITE.sigs, sa.rcc.ova.syn.exp)
stopifnot(!dir.exists(OutDir("sa.sa.COMPOSITE/")))
dir.create(OutDir("sa.sa.COMPOSITE/"))
WriteCatCOMPOSITE(sa.COMPOSITE.sigs, 
                  path = OutDir("sa.sa.COMPOSITE/input.sigs.csv"))
WriteCatCOMPOSITE(sa.sa.COMPOSITE,
                  OutDir("sa.sa.COMPOSITE/syn.data.csv"))

sa.sa.96 <- GenSynCatalogs(sa.96.sigs, sa.rcc.ova.syn.exp)
stopifnot(!dir.exists(OutDir("sa.sa.96/")))
dir.create(OutDir("sa.sa.96/"))
WriteCat96(sa.sa.96,
           path = OutDir("sa.sa.96/input.sigs.csv"))
WriteCat96(sa.sa.96, OutDir("sa.sa.96/syn.data.csv"))
```

#### Read SigProfiler mutational signature profiles and create synthetic catalogs


```{r sigprofilerinputprofiles}
# Read SigProfiler 96-channel signature profiles
sp.sigs <-
  ReadCat96("sigProfiler_SBS_signatures_2018_03_28.csv",
            strict = FALSE)
```

Create the catalogs. First we need the matching between SigProfiler
and SignatureAnalyzers signatures.

```{r}
MapSPToSASignatureNamesInExposure <-
  function(sp.exposures, sp.sigs, sa.96.sigs) {
  SP.SA.mappings <-
    MatchSigs2Directions(sp.sigs[ , rownames(sp.exposures)], sa.96.sigs)
  new.syn.exp.rownames <- SP.SA.mappings$match1[rownames(sp.exposures), "to"]
  exp2 <- sp.exposures
  rownames(exp2) <- new.syn.exp.rownames
  return(list(exp2               = exp2, 
              sp.to.sa.sig.match = SP.SA.mappings$match1,
              sa.to.sp.sig.match = SP.SA.mappings$match2))
}

sp.sa.map.info <-
  MapSPToSASignatureNamesInExposure(sp.rcc.ova.syn.exp, sp.sigs, sa.96.sigs)
stopifnot(!dir.exists(OutDir("sp.sa.COMPOSITE/")))
dir.create(OutDir("sp.sa.COMPOSITE/"))
sp.sa.COMPOSITE <- 
  GenSynCatalogs(sa.COMPOSITE.sigs, sp.sa.map.info$exp2)
WriteCatCOMPOSITE(sa.COMPOSITE.sigs,
                  path = OutDir("sp.sa.COMPOSITE/input.sigs.csv"))
WriteCatCOMPOSITE(sp.sa.COMPOSITE,
                  OutDir("sp.sa.COMPOSITE/syn.data.csv"))

```

```{r}
knitr::kable(
  sp.sa.map.info$sp.to.sa.sig.match, 
  caption = 'Best matches from SP signatures to SA signatures',
  digits = 4
)
```
```{r echo=FALSE}
if (FALSE) {
knitr::kable(
  sp.sa.map.info$sa.to.sp.sig.match, 
  caption =
    paste('Best (reverse) matches from SA signatures",
          "to SP signatures (for sanity checking)'),
  digits = 4
)
}
```


```{r, echo=F}
## Digression, all best matches between SignatureAnalyzer and SigProfier 96-channel signatures

if (FALSE) {
tmp <- MatchSigs2Directions(sp.sigs, sa.96.sigs)
knitr::kable(
  tmp$match1, 
  caption = 'match1',
  digits = 4
)

knitr::kable(
  tmp$match2, 
  caption = 'match2',
  digits = 4
)
}
```

```{r}
sp.sp <- GenSynCatalogs(sp.sigs, sp.rcc.ova.syn.exp)
stopifnot(!dir.exists(OutDir("sp.sp/")))
dir.create(OutDir("sp.sp/"))
WriteCat96(sp.sigs, OutDir("sp.sp/input.sigs.csv"))
WriteCat96(sp.sp, OutDir("sp.sp/syn.data.csv"))
```

## Example 2: Pull out only 3, 5, 40 and make an "abstract" synthetic data set

### Pull together the parameters

```{r}
x.sp.parms <-
  cbind(rcc.info$sp.parms[ , c("SBS5", "SBS40")],
        ovary.info$sp.parms[ , "SBS3", drop = FALSE])

# Find mapping from SBS3, SBS5, and SBS40 to SignatureAnalyzer signatures
# assigned to these tumor types

MatchSigs1Direction(
  sp.sigs[ , "SBS5", drop = F], 
  sa.96.sigs[ , FixSASigNames(rownames(rcc.info$sa.syn.exp))])

MatchSigs1Direction(
  sp.sigs[ , "SBS40", drop = F], 
  sa.96.sigs[ , FixSASigNames(rownames(rcc.info$sa.syn.exp))])

MatchSigs1Direction(
  sp.sigs[ , "SBS3", drop = F], 
  sa.96.sigs[ , FixSASigNames(rownames(ovary.info$sa.syn.exp))])


# Both BI..SBS3 and BI..SBS39 are in every ovarian; we select BI..SBS3

x.sa.parms <-
  cbind(rcc.info$sa.parms[ , c("BI_COMPOSITE_SBS5_P",
                               "BI_COMPOSITE_SBS40_P")],
        ovary.info$sa.parms[ , "BI_COMPOSITE_SBS3_P", drop = FALSE])

knitr::kable(
  x.sa.parms, 
  caption = 'SignatureAnalyzer parameters',
  digits = 4
)

knitr::kable(
  x.sp.parms, 
  caption = 'SigProfiler parameters',
  digits = 4
)
```

As above, we do not put the output in a git-managed directory.
```{r}
SetNewOutDir("../../syn.3.5.40.abst.v5/")
set.seed(44)
num.syn.tumors <- 1000

sp.abst.info <-
  GenerateSynAbstract(
    x.sp.parms, num.syn.tumors, "sp", "SP.Syn.Abst")

sa.abst.info <-
  GenerateSynAbstract(
    x.sa.parms,
    num.syn.tumors, "sa", "SA.Syn.Abst")

```

#### Generate and write SignatureAnalyzer "abstract" 3, 5, 40 catalogs

```{r}
sa.sa.COMPOSITE <- 
  GenSynCatalogs(sa.COMPOSITE.sigs, sa.abst.info$syn.exp)

stopifnot(!dir.exists(OutDir("sa.sa.COMPOSITE/")))
dir.create(OutDir("sa.sa.COMPOSITE/"))
WriteCatCOMPOSITE(sa.sa.COMPOSITE,
                  OutDir("sa.sa.COMPOSITE/syn.data.csv"))

sa.sa.96 <- GenSynCatalogs(sa.96.sigs, sa.abst.info$syn.exp)

stopifnot(!dir.exists(OutDir("sa.sa.96/")))
dir.create(OutDir("sa.sa.96/"))
WriteCat96(sa.sa.96, OutDir("sa.sa.96/syn.data.csv"))
```

#### Generate and write SigProfiler "abstract" 3, 5, 40 catalogs

```{r}
tmp.exp <- sp.abst.info$syn.exp
rownames(tmp.exp) <- rownames(sa.abst.info$syn.exp)
sp.sa.COMPOSITE <- 
  GenSynCatalogs(sa.COMPOSITE.sigs, tmp.exp)
stopifnot(!dir.exists(OutDir("sp.sa.COMPOSITE/")))
dir.create(OutDir("sp.sa.COMPOSITE/"))
WriteCatCOMPOSITE(sp.sa.COMPOSITE,
                  OutDir("sp.sa.COMPOSITE/syn.data.csv"))

sp.sp <- GenSynCatalogs(sp.sigs, sp.abst.info$syn.exp)

stopifnot(!dir.exists(OutDir("sp.sp/")))
dir.create(OutDir("sp.sp/"))
WriteCat96(sp.sp, OutDir("sp.sp/syn.data.csv"))

```

## Turn this into a test

```{r}
# ReadSigProfilerSig96("example-SP-signatures.txt")

```
