## SynSigTests v0.6
## 2018 12 11
## 

source("ICAMS_set_cat_globals.R")
SetCatGlobals()
source("ICAMS_read_write_cat.R")
source("mSigTools.v0.11.R")


test.params <- structure(c(0.544604316546763, 0.0706434604585199, 0.563928764100521,              
                           0.0845323741007194, 0.171016732676307, 0.90471310053776, 0.0571942446043165,       
                           0.425828455262418, 2.26857993819654, 0.916906474820144, 0.227295433741099,         
                           4.49138545316635, 0.0309352517985612, 1.99728078123427, 13.6071799847063,          
                           0.0129496402877698, 1.67229757896425, 9.17076003456564, 0.0154676258992806,        
                           0.108354642773247, 0.604174554778502, 0.0302158273381295, 0.096403490689205,       
                           0.463604770676788, 0.00323741007194245, 13.7030800064133, 59.5033455672184,        
                           0.000719424460431655, 1.79046897546898, 12.6089059501063, 0.0694244604316547,      
                           0.191133840253011, 0.831608429720346, 0.0838129496402878, 0.182337971994624,       
                           1.04372512153238, 0.00107913669064748, 3.42613756613757, 19.8168998774966,         
                           0.00215827338129496, 2.36079365079365, 11.6306390323685, 0.00467625899280576,      
                           0.191683871683872, 0.782432690275866, 0.0248201438848921, 0.416805320283581,       
                           1.54346261401261, 0.0464028776978417, 0.368528921552177, 1.47188408357788,         
                           0.174460431654676, 0.0932611237559691, 0.487262890383516, 0.0194244604316547,      
                           0.0357952541285875, 0.338960892412201, 0.00143884892086331, 2.42518037518038,      
                           10.2988714864264, 0.00683453237410072, 0.291939697729171, 1.34652560963361,        
                           0.00431654676258993, 0.765412457912458, 2.9920303799597, 0.00575539568345324,      
                           7.83612283549784, 45.0985681445623, 0.010431654676259, 0.0454475792406827,         
                           0.264924134886788, 0.000359712230215827, 0.0483838383838384,                       
                           0.263784540338454, 0.000719424460431655, 0.13525974025974, 0.405271581127199,      
                           0.00935251798561151, 0.0596858696858697, 0.465083069057702, 0.0111510791366906,    
                           0.269446073639622, 1.80234370560171, 0.00179856115107914, 0.123670995670996,       
                           0.473944027559461, 0.0100719424460432, 0.0277432488146774, 0.133211425742402,      
                           0.440647482014388, 0.0958552522307624, 0.517652022528495, 0.00215827338129496,     
                           0.00383597883597884, 0.0193899141479016, 0.00863309352517986,                      
                           1.49873496873497, 8.11843812971262), .Dim = c(3L, 33L), .Dimnames = list(          
                             c("prob", "mean", "stdev"), c("SBS1", "SBS2", "SBS4", "SBS5",    
                                                           "SBS7a", "SBS7b", "SBS8", "SBS9", "SBS10a", "SBS11", "SBS12",    
                                                           "SBS13", "SBS14", "SBS15", "SBS16", "SBS17a", "SBS17b", "SBS18", 
                                                           "SBS19", "SBS21", "SBS22", "SBS26", "SBS28", "SBS30", "SBS31",   
                                                           "SBS33", "SBS36", "SBS37", "SBS38", "SBS39", "SBS40", "SBS44",   
                                                           "SBS60"))) 

example.assignment <- structure(c(1496, 1296, 0, 0, 1825, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 806, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                  0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9477, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 985, 0, 0, 0, 922, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3181, 0, 0, 0, 0, 
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1111, 526, 0,  0, 1419, 0, 0, 0, 0, 0, 0, 0, 
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                  0,  2867, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 1803, 1271, 0, 0, 2199, 
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1194,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                  0, 0, 0,  0, 0, 0, 0, 0, 0, 5944, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 
                                  441, 461, 0, 0, 840, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 481, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                  0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1233, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 
                                  0, 0, 0, 0, 0, 0, 122, 0, 0, 0, 6599, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 1968, 0, 0, 0, 0, 0, 0, 0,
                                  0, 0, 0,  0, 0, 2618, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0,
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 571,  0, 0, 0, 3804, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                  0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2187, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 1926, 547, 0, 0, 512, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 402, 0,
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 6581, 0, 0, 0, 0, 0, 0, 
                                  0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2432, 1153, 0, 0, 2050, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0,
                                  0, 0, 0, 0, 0, 1797, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5878, 0, 0, 0,  0,
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2210, 1605,  0, 0, 2631, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                                  0, 1209, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 5219, 0, 0,
                                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0
), .Dim = c(65L, 10L), .Dimnames = list(c("SBS1", "SBS2",  "SBS3", "SBS4", "SBS5", "SBS6", "SBS7a", "SBS7b",
                                          "SBS7c", "SBS7d",  "SBS8", "SBS9", "SBS10a", "SBS10b", "SBS11", 
                                          "SBS12", "SBS13",  "SBS14", "SBS15", "SBS16", "SBS17a", "SBS17b", 
                                          "SBS18", "SBS19",  "SBS20", "SBS21", "SBS22", "SBS23", "SBS24", 
                                          "SBS25", "SBS26",  "SBS27", "SBS28", "SBS29", "SBS30", "SBS31", 
                                          "SBS32", "SBS33",  "SBS34", "SBS35", "SBS36", "SBS37", "SBS38", 
                                          "SBS39", "SBS40",  "SBS41", "SBS42", "SBS43", "SBS44", "SBS45", 
                                          "SBS46", "SBS47",  "SBS48", "SBS49", "SBS50", "SBS51", "SBS52", 
                                          "SBS53", "SBS54",  "SBS55", "SBS56", "SBS57", "SBS58", "SBS59", "SBS60"),
                                        c("Biliary.AdenoCA..SP117655",  "Biliary.AdenoCA..SP117556", 
                                          "Biliary.AdenoCA..SP117627", "Biliary.AdenoCA..SP117775",  
                                          "Biliary.AdenoCA..SP117332", "Biliary.AdenoCA..SP117712", 
                                          "Biliary.AdenoCA..SP117017",  "Biliary.AdenoCA..SP117031", 
                                          "Biliary.AdenoCA..SP117759", "Biliary.AdenoCA..SP117621" )))

human.genome.size <- 2100 
human.exome.size  <- 50

set.seed(1066) 
test.estimate.params <- synsig.params.from.attributions(counts = example.assignment)


## output is counts.per.mb per signature in each sample
test.exposure.mb <- generate.synthetic.exposures(sig.params = test.estimate.params, 
                                                 num.samples = 15)

## load signatures outside the function so that any signature matrix can be used 
sp <-  get.signatures(signature.file = # './PCAWG_signatures.csv',
                        "sigProfiler_SBS_signatures_2018_03_28.csv",
                    exome.op = .h19.96.sureselect.v6.op)


## multiply exposures.per.mb with target size (to generate exomes).
test.exp.counts <- test.exposure.mb * human.exome.size  

## convert to mat will fail if ncol of sig.mat != nrow of exp.mat
test.sigs <- sp$exome[, match(rownames(test.exp.counts),
                            colnames(sp$exome))]

## snippet for 192 signature
# path <- './sigProfiler_TSB_signatures.csv'
# sp.192 <- read.192.sp.format(path = path)
# ## test other than 96 class signatures
# test.sigs <- sp.192[, match(rownames(test.exp.counts),
#                               colnames(sp.192))]

## convert to a matrix of counts with dimensions nrow = nrow(signature.matrix)
test.mat <- convert.exp.to.mat(signature.matrix = test.sigs,   
                               exposure.matrix = test.exp.counts)

## plot out spectra without noise
pdf.mut.sig.profile('test.matrix.no.noise.pdf', 
                    test.mat, 
                    show.counts = T)

## plot out spectra with noise
test.noise <-  add.neg.binom.noise(test.mat)
pdf.mut.sig.profile('test.matrix.noise.pdf', 
                    test.noise, 
                    show.counts = T)






