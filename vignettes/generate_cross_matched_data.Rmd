---
title: "Generate cross-matched SignatureAnalyzer and SigProfiler synthetic data"
author: "Steve Rozen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate cross-matched SignatureAnalyzer and SigProfiler synthetic data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Conceptual challenges arise when comparing extraction of signatures between
different categorizations of mutation types.  

For example, in PCAWG7, SigProfiler reference signatures are based on
extraction of 96-channel signatures (i.e. single base substitutions -- SBS or SNS),
while SignatureAnalyzer reference signatures  are based on extraction of
"COMPOSITE" signatures consisting of SBS in pentanucleotide context plus
double base substitutions (DBSs) and indels (IDs).

A second challenge in generating "realistic" synthetic data is deciding
how many signatures operate in a given tumor time. Here we address
this challenge by generating different synthetic data sets, one
based on the larger number of signatures as extracted by
SignatureAnalyzer, and one based on the smaller number of signatures
extracted by SigProfiler.

In the end we take the cross product of the two choices, that is,
\verbatim{
 {96-channel, COMPOSITE} X {SignatureAnalyzer-attributions, SigProfiler-attributions}
}

### Required libraries and data

```{r readSPprofiles}
library(ICAMS)
library(SynSig)
library(data.table) # check to see if ReadCat96 imports fread
```

A utility function

```{r}
OutDir <- function(file.name) {
  if (is.null(out.data.root)) return(file.name)
  else {
    if (!dir.exists(out.data.root)) {
      dir.create(out.data.root)
    }
    return(paste0(out.data.root, file.name))
  }
}
```

Read SignatureAnalyzer exposures.

```{r signatureanalyzerexposure}

# TODO(Steve): wrap this in a function
sa.no.hyper.real.exposures <- 
  read.table(
    "SignatureAnalyzer_COMPOSITE_SNV.activity.no_POLE_MSI_SKIN_TMZ.031918.txt",
             sep = "\t", row.names = 1, header = TRUE)
colnames(sa.no.hyper.real.exposures) <-
  sub("__", "::", colnames(sa.no.hyper.real.exposures), fixed = TRUE)
colnames(sa.no.hyper.real.exposures) <-
  sub("_", "-", colnames(sa.no.hyper.real.exposures), fixed = TRUE)
```

Read SigProfiler exposures and restrict on "non hyper mutated" as
defined by the SignatureAnalyzer exposures.

```{r sigprofilerinputs}
# TODO(Steve): wrap this in a function
sp.real.exposures <-
  read.csv("PCAWG_sigProfiler_SBS_signatures_in_samples.csv",
                  as.is = TRUE, header = T)
rownames(sp.real.exposures) <-
  paste0(sp.real.exposures$Cancer.Types, "::", sp.real.exposures$Sample.Names)
sp.real.exposures <- t(sp.real.exposures[ , -(1:3)])
sp.no.hyper.real.exposures <- 
  sp.real.exposures[ , colnames(sa.no.hyper.real.exposures)]
```

## Functions to generate parallel synthetic data from SA and SP attributions and signature profiles

```{r}
GenerateSynFromReal <-
  function(real.exp, num.syn.tumors, file.prefix, id.prefix) {
  parms <- GetSynSigParamsFromExposures(real.exp)
  
  froot <- OutDir(file.prefix)
  
  WriteExposure(real.exp, paste0(froot, "real-exp.csv"))
  
  parm.file <- paste0(froot, "parms.csv")
  WriteSynSigParams(parms, parm.file)

  syn.exp <- 
    GenerateSyntheticExposures(parms, num.syn.tumors, id.prefix)

  WriteExposure(syn.exp, paste0(froot, "syn-exp.csv"))
  
  # Sanity check
  check.params <- GetSynSigParamsFromExposures(syn.exp)
  
  # sa.check.param should be similar to parms
  WriteSynSigParams(check.params, parm.file, append = TRUE)
  WriteSynSigParams(parms - check.params, parm.file,
                    append = TRUE)

  return(list(parms=parms, syn.exp=syn.exp))
}

SAAndSPSynDataOneCAType <-
  function(sa.real.exp, 
           sp.real.exp,
           ca.type,
           num.syn.tumors,
           file.prefix) {
    ca.type <- paste0(ca.type, "::")
    samples.to.use <- 
      grep(ca.type, colnames(sa.real.exp), fixed = TRUE)
    sa.exp <- sa.real.exp[ , samples.to.use]
    sp.exp <- sp.real.exp[ , samples.to.use]
    stopifnot(colnames(sa.exp) == colnames(sp.exp))
    sa.info <-
      GenerateSynFromReal(sa.exp, num.syn.tumors, 
                          paste0("sa-", file.prefix),
                          paste0("SA_Syn_", ca.type, "S"))
    sp.info <-
      GenerateSynFromReal(sp.exp, num.syn.tumors,
                          paste0("sp-", file.prefix),
                          paste0("SP_Syn_", ca.type, "S"))
    return(list(
      sa.parms  = sa.info$parms,
      sa.syn.exp = sa.info$syn.exp,
      sp.parms   = sp.info$parms,
      sp.syn.exp = sp.info$syn.exp))
}
```


## Example 1, Kidney-RCC and ovarian adenocarcinoma to explore SBS3, SBS5, and SBS40


```{r}
out.data.root <<- "syn_sbs3_5_40/"  # Must be a directory; be sure to end in "/"
set.seed(191905)
num.syn.tumors <- 500

rcc.info <- 
  SAAndSPSynDataOneCAType(
    sa.no.hyper.real.exposures,
    sp.no.hyper.real.exposures,
    "Kidney-RCC",
    num.syn.tumors,
    "RCC")
```

```{r}

ovary.info <- 
  SAAndSPSynDataOneCAType(
    sa.no.hyper.real.exposures,
    sp.no.hyper.real.exposures,
    "Ovary-AdenoCA",
    num.syn.tumors,
    "OVA")

```


```{r} 
Merge2Exposures <- function(exp1, exp2) {
  # Rows are signatures
  exp.m <- merge(exp1, exp2, by = 0, all = TRUE)
  rownames(exp.m) <- exp.m[ ,1]
  exp.m <- exp.m[ , -1]
  exp.m[is.na(exp.m)] <- 0
  return(as.matrix(exp.m))
}

MergeExposures <- function(list.of.exposures) {
  stopifnot(length(list.of.exposures) > 0) 
  if (length(list.of.exposures) == 1) {
    return(as.matrix(list.of.exposures[[1]]))
  }
  start <- list.of.exposures[[1]]
  for (i in 2:length(list.of.exposures)) {
    start <- Merge2Exposures(start, list.of.exposures[[i]])
  }
  return(as.matrix(start))
}

```

Combine the RCC and ovarian adenocarcinoma synthetic exposures

```{r} 
# debug(MergeExposures)
sa.syn.exp <-
  MergeExposures(list(rcc.info$sa.syn.exp, ovary.info$sa.syn.exp))
# Special adjustment -- SignatureAnalyzer signatures in exposures are 
# named differently than in the signature profile matrix.
# TODO(Steve): possibly move this to the point at which
# expsoures are read in.
rownames(sa.syn.exp) <-
  gsub("_SNV_", "_", rownames(sa.syn.exp), fixed = TRUE)

sp.syn.exp <-
  MergeExposures(list(rcc.info$sp.syn.exp, ovary.info$sp.syn.exp))

```


## Generate synthetic catalogs based on SignatureAnalyzer attributions

### Read SignatureAnalyzer mutational signature profiles and create synthetic catalogs

```{r signatureanalzyersigs}
                           
# COMPOSITE signature profiles
sa.COMPOSITE.sigs <- ReadSASigsCOMPOSITE()

# 96-channel signature profiles
sa.96.sigs <- 
  ReadSACat96("SignatureAnalyzer_COMPOSITE_SBS_W96.signature.031918.txt")
# Special adjustment -- SignatureAnalyzer signatures in exposures are 
# named differently than in the signature profile matrix.
# TODO(Steve): possibly move this to the point at which
# expsoures are read in.
colnames(sa.96.sigs) <-
    gsub("_SNV_", "_", colnames(sa.96.sigs), fixed = TRUE)
```

```{r}
sa.sa.COMPOSITE <- 
  GenSynCatalogs(sa.COMPOSITE.sigs, sa.syn.exp)
WriteCatCOMPOSITE(sa.sa.COMPOSITE,
                  OutDir("sa.sa.COMPOSITE.RCC.and.OVA.csv"))

sa.sa.96 <- GenSynCatalogs(sa.96.sigs, sa.syn.exp)

WriteCat96(sa.sa.96, OutDir("sa.96.RCC.and.OVA.csv"))
```

### Read SigProfiler mutational signature profiles and create synthetic catalogs


```{r sigprofilerinputprofiles}
# Read SigProfiler 96-channel signature profiles
sp.sigs <-
  ReadCat96("sigProfiler_SBS_signatures_2018_03_28.csv",
            strict = FALSE)
```

Create the catalogs. First we need the matching between SigProfiler
and SignatureAnalyzers signatures.

```{r}
MapSPToSASignatureNames <- function() {
  SP.SA.mappings <-
    MatchSigs2Directions(sp.sigs[ , rownames(sp.syn.exp)], sa.96.sigs)
  new.syn.exp.rownames <- SP.SA.mappings$match1[rownames(sp.syn.exp), "to"]
  exp2 <- sp.syn.exp
  rownames(exp2) <- new.syn.exp.rownames
  return(list(exp2               = exp2, 
              sp.to.sa.sig.match = SP.SA.mappings$match1,
              sa.to.sp.sig.match = SP.SA.mappings$match2))
}

sp.sa.map.info <- MapSPToSASignatureNames()
sp.sa.COMPOSITE <- 
  GenSynCatalogs(sa.COMPOSITE.sigs, sp.sa.map.info$exp2)
WriteCatCOMPOSITE(sp.sa.COMPOSITE,
                  OutDir("sp.sa.COMPOSITE.RCC.and.OVA.csv"))

```

knitr::kable(
  sp.sa.map.info$sp.to.sa.sig.match, 
  caption = 'Best matches from SP signtures to SA signatures',
  digits = 4
)

knitr::kable(
  sp.sa.map.info$sa.to.sp.sig.match, 
  caption = 'Best (reverse) matches from SA signtures to SP signatures (for sanity checking)',
  digits = 4
)

```{r}

#TODO CREATE AND WRITE THE sp.sp synthetic catalogs here ; the pull out only 3, 5, 40
# and make new data set.

```


## Turn this into a test

```{r}

ReadSigProfilerSig96("example-SP-signatures.txt")




```
